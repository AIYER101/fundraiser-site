<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Live Total ‚Äî Chilli Challenge</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

<div class="nav">
  <div class="container nav-inner">
    <div class="badge">KPMG √ó ACT Wildlife</div>
    <div class="nav-links">
      <a class="pill" href="index.html">Home</a>
      <a class="pill" href="donate.html">Donate</a>
      <a class="pill" href="total.html">Live Total</a>
    </div>
  </div>
</div>

<div class="container">
  <section class="hero" style="min-height:280px">
    <img src="chilli.jpg" alt="Chilli background" />
    <div class="hero-content">
      <div class="kicker">Live Total</div>
      <div class="h1">Chilli Challenge Meter üå∂Ô∏è</div>
      <p class="lede">Auto-updating total + current pepper tier.</p>
      <a class="btn" href="donate.html">Donate now ‚Üí</a>
      <span class="badge" id="status" style="margin-left:10px">loading‚Ä¶</span>
    </div>
  </section>

  <div class="grid" style="margin-top:14px">
    <div class="card">
      <div class="muted">Last updated</div>
      <div style="font-weight:800;margin-top:6px" id="updated">‚Äî</div>

      <div class="muted" style="margin-top:14px">Total raised</div>
      <div class="big-number" id="total">$0</div>

      <div class="progress" aria-label="Progress"><div id="fill"></div></div>
      <div class="muted" style="margin-top:10px">
        Current tier progress: <span id="tierProgress">‚Äî</span>
      </div>
    </div>

    <div class="card">
      <h2>Current pepper</h2>
      <div style="font-size:36px;font-weight:900;margin-top:8px" id="pepperName">‚Äî</div>
      <div class="muted" style="margin-top:6px">
        Scoville: <b id="scoville">‚Äî</b>
      </div>
      <div class="muted" style="margin-top:10px">
        Next target: <b id="nextTarget">‚Äî</b>
      </div>
    </div>
  </div>

  <div class="card">
    <h2>Full chilli ladder</h2>
    <div class="muted">Donation milestones mapped to the Scoville scale.</div>
    <div style="overflow:auto;margin-top:12px">
      <table style="width:100%;border-collapse:collapse">
        <thead>
          <tr>
            <th style="text-align:left;padding:10px;border-bottom:1px solid rgba(255,255,255,0.10)">Pepper</th>
            <th style="text-align:right;padding:10px;border-bottom:1px solid rgba(255,255,255,0.10)">Scoville</th>
            <th style="text-align:right;padding:10px;border-bottom:1px solid rgba(255,255,255,0.10)">Min donation</th>
          </tr>
        </thead>
        <tbody id="ladder"></tbody>
      </table>
    </div>
  </div>

  <footer>¬© KPMG √ó ACT Wildlife Fundraiser</footer>
</div>

<script>
  // Update frequency
  const REFRESH_MS = 15000;

  // Your exact ladder (min donation thresholds in AUD)
  const LADDER = [
    { name: "Capsicum", scoville: 0, min: 0 },
    { name: "Jalapeno", scoville: 5000, min: 5 },
    { name: "Chipotle Pepper", scoville: 10000, min: 10 },
    { name: "Serrano Pepper", scoville: 23000, min: 23 },
    { name: "Cayenne Pepper", scoville: 50000, min: 50 },
    { name: "Birds Eye Chilli", scoville: 100000, min: 100 },
    { name: "Jamaican Hot Pepper", scoville: 200000, min: 200 },
    { name: "Habanero", scoville: 350000, min: 350 },
    { name: "Chocolate Habanero", scoville: 450000, min: 450 },
    { name: "Red Savina Habanero", scoville: 577000, min: 577 },
    { name: "Black Naga", scoville: 700000, min: 700 },
    { name: "Trinidad 7 Pod", scoville: 850000, min: 850 },
    { name: "Ghost Pepper", scoville: 1000000, min: 1000 },
    { name: "Carolina reaper", scoville: 1500000, min: 1500 },
    { name: "Brown Moruga Scorpion", scoville: 2000000, min: 2000 }
  ];

  const fmtAUD = new Intl.NumberFormat("en-AU", { style:"currency", currency:"AUD", maximumFractionDigits: 0 });
  const fmtInt = new Intl.NumberFormat("en-AU");

  function setStatus(txt){ document.getElementById("status").textContent = txt; }

  function getCurrentTier(total){
    let current = LADDER[0];
    for (const tier of LADDER){
      if (total >= tier.min) current = tier;
    }
    const idx = LADDER.indexOf(current);
    const next = (idx + 1 < LADDER.length) ? LADDER[idx + 1] : null;
    return { current, next, idx };
  }

  function renderLadder(){
    const tbody = document.getElementById("ladder");
    tbody.innerHTML = "";
    for (const t of LADDER){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td style="padding:10px;border-bottom:1px solid rgba(255,255,255,0.08)">${t.name}</td>
        <td style="padding:10px;border-bottom:1px solid rgba(255,255,255,0.08);text-align:right">${fmtInt.format(t.scoville)}</td>
        <td style="padding:10px;border-bottom:1px solid rgba(255,255,255,0.08);text-align:right">${fmtAUD.format(t.min)}</td>
      `;
      tbody.appendChild(tr);
    }
  }

  async function fetchTotal(){
    const res = await fetch("./total.json?cb=" + Date.now(), { cache:"no-store" });
    if (!res.ok) throw new Error("Could not load total.json");
    return await res.json();
  }

  function clamp(n,min,max){ return Math.max(min, Math.min(max, n)); }

  async function update(){
    setStatus("updating‚Ä¶");
    const data = await fetchTotal();
    const total = Number(data.total || 0);

    document.getElementById("total").textContent = fmtAUD.format(total);

    const stamp = data.lastUpdated ? new Date(data.lastUpdated).toLocaleString("en-AU") : new Date().toLocaleString("en-AU");
    document.getElementById("updated").textContent = stamp;

    const { current, next } = getCurrentTier(total);
    document.getElementById("pepperName").textContent = current.name;
    document.getElementById("scoville").textContent = fmtInt.format(current.scoville);

    if (next){
      document.getElementById("nextTarget").textContent = `${fmtAUD.format(next.min)} (${next.name})`;

      // Tier progress (from current.min to next.min)
      const span = next.min - current.min;
      const into = total - current.min;
      const pct = span > 0 ? clamp((into / span) * 100, 0, 100) : 100;
      document.getElementById("fill").style.width = pct.toFixed(1) + "%";
      document.getElementById("tierProgress").textContent = `${fmtAUD.format(total)} of ${fmtAUD.format(next.min)} ‚Üí ${pct.toFixed(0)}%`;
    } else {
      // Max tier
      document.getElementById("nextTarget").textContent = "MAX TIER REACHED üî•";
      document.getElementById("fill").style.width = "100%";
      document.getElementById("tierProgress").textContent = "100% (top pepper unlocked)";
    }

    setStatus("live");
  }

  renderLadder();
  update().catch(err => { console.error(err); setStatus("error"); });
  setInterval(() => update().catch(err => { console.error(err); setStatus("error"); }), REFRESH_MS);
</script>
</body>
</html>
